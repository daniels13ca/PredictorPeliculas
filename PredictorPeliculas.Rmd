---
title: "Ratingpelis 0.2"
author: "Daniel Silva Barrera"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    source: embed
---

```{r setup, include=FALSE}

list.of.packages <- c("shiny", "flexdashboard", "ggplot2", "plotly", "dygraphs", "stringr")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)


library("shiny")
library("flexdashboard")
```

```{r}
library("ggplot2")
library("stringr")

data <- read.csv2(file="Formulario de calificación de películas (respuestas).csv", sep = ";", header = TRUE, 
        encoding="UTF-8")

col_names <- c("Fecha", "Titulo", "Resumen", "Link en The Movie DB", "Sexo", "Edad al momento de ver la pelicula", "Calificacion", "Genero")

names(data) <- col_names
data$Index <- seq.int(nrow(data))

list_genre <- str_split_fixed(data$Genero, ",", n=Inf)

col_number <- ncol(list_genre)
row_number <- nrow(list_genre)

genres_view <- data.frame(Index=integer(),
                          Genero=character())

for ( i in 1:row_number){
  for ( j in 1:col_number ){
    index_t <- i
    genre_t <- list_genre[i, j]
    
    if(genre_t != ""){
      genres_view[nrow(genres_view) + 1,] = c(index_t,genre_t)
    }
  }
}

data$Genero <- NULL

data <- merge(x = data, y = genres_view, by = "Index", all.y = TRUE)

data$Ano <-str_sub(data$Titulo,-5,-2)
data$Titulo = substr(data$Titulo,1,nchar(data$Titulo)-7)

genres <- unique(data$Genero)
```

Selecciones {.sidebar}
===============================

Seleccione los géneros a filtrar

```{r}
checkboxGroupInput("movie_type", label = "Generos", genres, selected = genres)
```

Calificaciones 
=====================================

Columna 1 {data-width=200}
------------------------------------
### Histograma

```{r}
library(plotly)

x <- list(title = "Calificacion")
y <- list(title = "Recuento")

renderPlotly({
  movies <- unique(top_movies[top_movies$Genero %in% input$movie_type, c(1, 2, 4)])
  g <- plot_ly(x = movies$Calificacion, type = "histogram") %>% layout(xaxis = x, yaxis = y)
  ggplotly(g)
})
```

Columna 2 {data-width=300}
-------------------------------------

### Calificaciones medias

```{r}
library(plotly)

renderValueBox({
  movies <- unique(top_movies[top_movies$Genero %in% input$movie_type, c(1, 2, 4)])
  valueBox(round(mean(movies$Calificacion), 2), icon = "ion-videocamera", 
           caption="Calificación media", color="blue")
})

```

### Películas calificadas

```{r}
library(plotly)

renderValueBox({
  movies <- unique(top_movies[top_movies$Genero %in% input$movie_type, c(1, 2, 4)])
  valueBox(nrow(movies), icon = "ion-videocamera", 
           caption="Películas calificadas", color="blue")
})

```

### Desviación estandar

```{r}
library(plotly)

renderValueBox({
  movies <- unique(top_movies[top_movies$Genero %in% input$movie_type, c(1, 2, 4)])
  valueBox(round(sd(movies$Calificacion), 2), icon = "ion-videocamera", 
           caption="Desviación estándar", color="blue")
})

```

### Tendencia histórica de calificaciones

```{r}
library(dygraphs)
renderDygraph({
  years <- unique(top_movies[top_movies$Genero %in% input$movie_type, c(1, 2, 4)])
  mean_by_year = tapply(years$Calificacion, years$Ano, mean)
  ## Create ts object
  x = ts(as.vector(mean_by_year), start=1920, end=2020)
  y = cbind(Rating=x)
  
  ## Plot code
  dygraph(y, main = "Tendencia de la calificación media", 
          ylab = "Calificación",group="Ratings") %>% 
    dyRangeSelector() %>%
    dyOptions(stepPlot = TRUE) %>%
    dySeries("V1", label = "Calificación")
})
```

Peliculas
===================================== 

Columna {.tabset .tabset-fade}
-------------------------------------

### Películas

```{r}

top_movies <- data[order(-data$Calificacion),]
top_movies <- top_movies[, c(3, 10, 9, 8)]

DT::renderDataTable({
  top_movies <- unique(top_movies[top_movies$Genero %in% input$movie_type, c(1, 2, 4)])
  DT::datatable(top_movies, rownames = FALSE)
})
```

Acerca de
===================================== 

### ¿Cómo funciona?

A raíz de lo poco acertadas que resultaban ser las calificaciones que los sitios de ratings más populares le daban a las películas frente a mi opinión personal, lo cual me llevaba a ver películas que no satisfacían mis expectativas, decidí crear mi propio sistema de calificación y a la vez un predictor de la posible calificación que yo le otorgaría a la película.

Para esto me base en el o en los géneros de las películas según [The Movie DB](https://www.themoviedb.org/). Para una segunda fase que permita pronosticar la calificación de otras personas pienso incluir otros predictores tales como: 

* Año de lanzamiento
* Edad del observador
* Sexo del observador
* Palabras claves del resumen

Si desean contribuir a enriquecer la base de datos lo pueden hacer diligenciando el siguiente formulario: [Calificación de película](https://forms.gle/y6bMuf16cKmyD6549)

Contacto: silvdaniel@gmail.com
